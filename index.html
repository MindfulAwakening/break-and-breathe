<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Break & Breathe ‚Äî v3.0.0</title>
<meta name="theme-color" content="#0b1324" />
<link rel="manifest" href="manifest.webmanifest" />
<style>
  :root{--bg:#0b1324;--card:#121c34;--accent:#8ad1ff;--text:#e8f0ff;--muted:#a9b8d6;--ring:rgba(138,209,255,.25);--good:#5ee4a7;--warn:#ffc76b;}
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans";
       color:var(--text);background:var(--bg);display:flex;align-items:flex-start;justify-content:center;padding:16px}
  .app{width:100%;max-width:1240px}
  .card{background:linear-gradient(180deg,rgba(18,28,52,.9),rgba(13,20,38,.92));
        border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:16px}
  header{position:relative;z-index:10;display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:8px;pointer-events:auto}
  .title{font-weight:700;font-size:clamp(18px,3.6vw,26px);display:flex;align-items:center;gap:10px}
  .badge{font-size:12px;padding:2px 8px;border-radius:999px;background:rgba(138,209,255,.12);color:var(--accent);border:1px solid rgba(138,209,255,.25)}
  .muted{color:var(--muted);font-size:12px}
  .grid{display:grid;gap:12px;grid-template-columns:1.2fr .9fr}
  .controls{position:relative;z-index:10;display:grid;grid-template-columns:1.2fr 1fr 1.1fr 1fr;gap:12px;margin:8px 0 6px;pointer-events:auto}
  @media (max-width:820px){.controls{grid-template-columns:1fr 1fr}.grid{grid-template-columns:1fr}}
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
  select,input[type="range"],input[type="time"],input[type="number"],input[type="password"],input[type="text"],.btn{
    width:100%;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.03);color:var(--text);
    border-radius:12px;padding:8px 10px;font-size:14px;outline:none}
  /* High-contrast dropdowns */
  select{
    border:1px solid rgba(255,255,255,.15);
    background: rgba(18,28,52,.95);
    color: #e8f0ff;
    appearance: none;
  }
  select option{background:#121c34;color:#e8f0ff;}
  .btn{cursor:pointer;text-align:center;user-select:none;transition:transform .05s ease}
  .btn:active{transform:translateY(1px)}
  .btn.primary{background:linear-gradient(180deg,rgba(138,209,255,.18),rgba(138,209,255,.08));border-color:rgba(138,209,255,.35)}
  .btn.ghost{background:rgba(255,255,255,.03)}
  .row{display:flex;gap:8px}.row>.btn{flex:1}
  .section{margin-top:10px;padding:12px;border:1px solid rgba(255,255,255,.06);border-radius:12px;background:rgba(255,255,255,.03)}
  .two-col{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  @media (max-width:820px){.two-col{grid-template-columns:1fr}}
  /* Pacer never blocks clicks */
  .pacer-wrap{position:relative;aspect-ratio:1/1;display:flex;align-items:center;justify-content:center;
              background:radial-gradient(40% 40% at 50% 50%,rgba(138,209,255,.1),rgba(255,255,255,.02));
              border-radius:18px;overflow:hidden;border:1px solid rgba(255,255,255,0.06);z-index:0;max-height:60vh;pointer-events:none}
  .pacer{width:min(300px,60%);aspect-ratio:1/1;border-radius:50%;border:2px solid var(--ring);
         box-shadow:0 0 50px 8px var(--ring),inset 0 0 40px rgba(138,209,255,.12);display:flex;align-items:center;justify-content:center;
         transform:scale(.88);transition:transform var(--phase-ms,3000ms) linear}
  .pacer .dot{width:12px;height:12px;border-radius:50%;background:var(--accent);box-shadow:0 0 18px var(--accent),0 0 40px var(--accent);opacity:.9}
  [data-phase="inhale"] .pacer{transform:scale(1.06)}
  [data-phase="exhale"] .pacer{transform:scale(.88)}
  [data-phase="hold"] .pacer{transform:scale(.97)}
  .hud{position:absolute;inset:8px 8px auto 8px;display:flex;justify-content:space-between;align-items:center;font-size:12px;color:var(--muted);pointer-events:none}
  .timer{position:absolute;inset:auto 0 18px 0;text-align:center;font-size:clamp(18px,4.5vw,40px);font-weight:700;letter-spacing:1.2px;pointer-events:none}
  .phase{position:absolute;inset:auto 0 66px 0;text-align:center;font-size:clamp(13px,3vw,17px);color:var(--muted);pointer-events:none}
  .mantra{position:absolute;inset:auto 0 102px 0;text-align:center;font-size:clamp(28px,6vw,48px);font-weight:700;letter-spacing:1.5px;opacity:.18;user-select:none;pointer-events:none}
  footer{margin-top:8px;color:var(--muted);font-size:12px;text-align:center}
</style>
</head>
<body>
  <div class="app">
    <div class="card">
      <header>
        <div class="title">üßò‚Äç‚ôÇÔ∏è Break &amp; Breathe <span class="badge">MVP v3.0.0</span></div>
        <div class="muted">Space = start/pause ¬∑ R = reset</div>
      </header>

      <div class="controls">
        <div>
          <label for="mode">Breathing Mode</label>
          <select id="mode">
            <option value="hongsau">Hong-Sau</option>
            <option value="equal">Equal</option>
            <option value="box">Box 4-4-4-4</option>
            <option value="478">4-7-8</option>
          </select>
        </div>
        <div>
          <label for="duration">Session Length: <span id="durationLabel">20</span> min</label>
          <input type="range" id="duration" min="1" max="60" step="1" value="20" />
        </div>
        <div>
          <label>Sound, Mantra &amp; Guidance</label>
          <div class="row">
            <button id="sound" class="btn ghost" aria-pressed="false">üîî Chime: Off</button>
            <button id="mantraBtn" class="btn ghost" aria-pressed="true">üïâÔ∏è Mantra: On</button>
            <button id="guidedBtn" class="btn ghost" aria-pressed="true">üéß Guided Voice: On</button>
          </div>
        </div>
        <div>
          <label>Controls</label>
          <div class="row">
            <button id="startPause" class="btn primary">‚ñ∂ Start</button>
            <button id="reset" class="btn ghost">‚ü≤ Reset</button>
          </div>
        </div>
      </div>

      <div class="grid">
        <!-- PACER / TIMER -->
        <div class="pacer-wrap card" id="stage" data-phase="ready" aria-live="polite" aria-atomic="true">
          <div class="hud"><div id="status" class="muted">Ready</div><div id="progress" class="muted">0%</div></div>
          <div class="pacer" id="pacer" aria-hidden="true"><div class="dot"></div></div>
          <div class="mantra" id="mantra" aria-hidden="true"></div>
          <div class="phase" id="phase">‚Äî</div>
          <div class="timer" id="timer">20:00</div>
        </div>

        <!-- RIGHT: scheduling + voice (Posture Check removed) -->
        <div>
          <div class="section">
            <h3>Work Hours & Break Reminders</h3>
            <div class="two-col">
              <div><label for="workStart">Workday starts</label><input type="time" id="workStart" value="08:00"></div>
              <div><label for="workEnd">Workday ends</label><input type="time" id="workEnd" value="17:00"></div>
              <div><label for="breakEvery">Break every (minutes)</label><input id="breakEvery" type="number" min="15" max="180" step="5" value="60"></div>
              <div><label for="stretchLead">Stretch reminder (minutes before break)</label><input id="stretchLead" type="number" min="0" max="10" step="1" value="2"></div>
            </div>
            <div class="two-col" style="margin-top:8px">
              <div><label>Reminder style</label>
                <select id="reminderStyle">
                  <option value="voice">Voice (spoken)</option>
                  <option value="chime">Chime</option>
                  <option value="both">Both</option>
                </select>
              </div>
              <div><label>&nbsp;</label>
                <div class="row">
                  <button id="startWork" class="btn primary">üü¢ Start Workday</button>
                  <button id="stopWork" class="btn ghost">‚õî Stop</button>
                </div>
              </div>
            </div>
            <div class="row" style="margin-top:8px">
              <span class="muted">Next break: <b id="nextBreakLabel">‚Äî</b></span>
              <span class="muted" style="margin-left:12px">Status: <b id="workStatus" class="warn">stopped</b></span>
              <button id="testReminder" class="btn ghost" style="margin-left:auto">Test announcement</button>
            </div>
          </div>

          <div class="section">
            <h3>Voice Settings</h3>

            <div class="two-col">
              <div>
                <label for="voiceSource">Voice Source</label>
                <select id="voiceSource">
                  <option value="browser">Browser TTS</option>
                  <option value="elA">ElevenLabs A</option>
                  <option value="elB">ElevenLabs B</option>
                </select>
                <div class="muted" style="margin-top:4px">Pick ElevenLabs A/B for premium voices.</div>
              </div>

              <div id="browserVoiceBlock">
                <label for="voiceSelect">Browser Voice</label>
                <select id="voiceSelect"></select>
                <div class="muted" id="voiceStatus" style="margin-top:4px">Loading voices‚Ä¶</div>
              </div>
            </div>

            <div class="two-col" id="elCreds" style="margin-top:8px; display:none">
              <div>
                <label for="elApiKey">ElevenLabs API Key</label>
                <input id="elApiKey" type="password" placeholder="Paste your API key" />
              </div>
              <div>
                <label>&nbsp;</label>
                <div class="row">
                  <button id="saveElCreds" class="btn ghost">üíæ Save</button>
                  <button id="clearElCreds" class="btn ghost">üóë Clear</button>
                </div>
              </div>
            </div>

            <div class="two-col" id="elVoices" style="margin-top:8px; display:none">
              <div>
                <label for="elVoiceA">Voice A ID</label>
                <input id="elVoiceA" type="text" placeholder="e.g. 21m00Tcm4TlvDq8ikWAM" />
                <div class="row" style="margin-top:6px">
                  <button id="testElA" class="btn ghost">üîä Test A</button>
                </div>
              </div>
              <div>
                <label for="elVoiceB">Voice B ID</label>
                <input id="elVoiceB" type="text" placeholder="Paste your voice ID" />
                <div class="row" style="margin-top:6px">
                  <button id="testElB" class="btn ghost">üîä Test B</button>
                </div>
              </div>
            </div>

            <div class="two-col" style="margin-top:8px">
              <div><label>Rate (speed): <span id="rateLbl">0.9</span></label><input id="voiceRate" type="range" min="0.6" max="1.4" step="0.05" value="0.9"></div>
              <div><label>Pitch: <span id="pitchLbl">1.0</span></label><input id="voicePitch" type="range" min="0.7" max="1.3" step="0.05" value="1.0"></div>
            </div>
            <div class="two-col" style="margin-top:8px">
              <div><label>Volume: <span id="volLbl">1.0</span></label><input id="voiceVol" type="range" min="0.2" max="1.0" step="0.05" value="1.0"></div>
              <div class="row" style="align-items:end">
                <button id="saySample" class="btn ghost">üîä Try Sample</button>
                <button id="reloadVoices" class="btn ghost">‚Üª Reload Browser Voices</button>
                <button id="unlockAudio" class="btn ghost">üîì Unlock Audio</button>
                <button id="useDefault" class="btn ghost">‚úî Use Default</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <footer class="muted">If your site is public, don‚Äôt hard-code your ElevenLabs key. Enter it above or use a proxy.</footer>
    </div>
  </div>

<script>
(function(){
  'use strict';
  const $=id=>document.getElementById(id);

  // Core elements
  const modeEl=$('mode'), durationEl=$('duration'), durationLabel=$('durationLabel');
  const startPauseBtn=$('startPause'), resetBtn=$('reset'), soundBtn=$('sound'), mantraBtn=$('mantraBtn'), guidedBtn=$('guidedBtn');
  const stage=$('stage'), timerEl=$('timer'), phaseEl=$('phase'), mantraEl=$('mantra'), statusEl=$('status'), progressEl=$('progress');

  // Scheduler
  const workStartEl=$('workStart'), workEndEl=$('workEnd'), breakEveryEl=$('breakEvery'), stretchLeadEl=$('stretchLead'), reminderStyleEl=$('reminderStyle');
  const startWorkBtn=$('startWork'), stopWorkBtn=$('stopWork'), nextBreakLabel=$('nextBreakLabel'), workStatus=$('workStatus'), testReminderBtn=$('testReminder');

  // Voice (browser + ElevenLabs)
  const voiceSource=$('voiceSource');
  const browserVoiceBlock=$('browserVoiceBlock');
  const elCreds=$('elCreds'), elVoices=$('elVoices');
  const voiceSelect=$('voiceSelect'), voiceStatus=$('voiceStatus');
  const elApiKey=$('elApiKey'), saveElCreds=$('saveElCreds'), clearElCreds=$('clearElCreds');
  const elVoiceA=$('elVoiceA'), elVoiceB=$('elVoiceB'), testElA=$('testElA'), testElB=$('testElB');

  const voiceRate=$('voiceRate'), voicePitch=$('voicePitch'), voiceVol=$('voiceVol'), rateLbl=$('rateLbl'), pitchLbl=$('pitchLbl'), volLbl=$('volLbl');
  const saySample=$('saySample'), reloadVoicesBtn=$('reloadVoices'), unlockAudioBtn=$('unlockAudio'), useDefaultBtn=$('useDefault');

  // State
  let running=false, sessionSeconds=parseInt(durationEl.value,10)*60, remaining=sessionSeconds, lastTick=null;
  let phase='ready', phaseRemaining=0, pattern=[];
  let soundOn=false, mantraOn=true, guidedOn=true;
  let workActive=false, nextBreakAt=null, nextStretchAt=null, schedulerTimer=null;
  let voices=[], selectedVoiceName='', audioCtx=null;

  // Local storage helpers
  const LS = {
    get(k){ try{return localStorage.getItem(k)}catch(_){return null} },
    set(k,v){ try{localStorage.setItem(k,v)}catch(_){} },
    del(k){ try{localStorage.removeItem(k)}catch(_){} }
  };

  // UI helpers
  const fmt=sec=>{sec=Math.max(0,Math.round(sec));const m=Math.floor(sec/60),s=sec%60;return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;};
  const computePattern=()=>{const m=modeEl.value;
    if(m==='hongsau')return[{phase:'inhale',secs:4.5},{phase:'exhale',secs:5.5}];
    if(m==='box')return[{phase:'inhale',secs:4},{phase:'hold',secs:4},{phase:'exhale',secs:4},{phase:'hold',secs:4}];
    if(m==='478')return[{phase:'inhale',secs:4},{phase:'hold',secs:7},{phase:'exhale',secs:8}];
    return[{phase:'inhale',secs:4},{phase:'exhale',secs:4}];
  };
  function setPhase(newPhase,ms){
    phase=newPhase; stage.dataset.phase=(newPhase==='hold'?'hold':newPhase);
    phaseEl.textContent=(newPhase==='hold')?'Hold':(newPhase.charAt(0).toUpperCase()+newPhase.slice(1));
    stage.style.setProperty('--phase-ms',(ms||1000)+'ms');
    if(mantraOn){
      mantraEl.textContent=(modeEl.value==='hongsau')?(newPhase==='inhale'?'HONG':(newPhase==='exhale'?'SAU':'')):(newPhase==='inhale'?'IN':(newPhase==='exhale'?'OUT':''));
      mantraEl.style.display='block';
    }else{ mantraEl.style.display='none'; }
    if(guidedOn){
      if(newPhase==='inhale') speak('Take a deep breath');
      else if(newPhase==='hold') speak('Hold it');
      else if(newPhase==='exhale') speak('Exhale slowly');
      else if(newPhase==='done') speak('Session complete');
    }
    if(soundOn && (newPhase==='inhale' || newPhase==='exhale' || newPhase==='done')){
      chime(newPhase==='exhale'?523.25:(newPhase==='done'?784:392));
    }
  }
  function resetSession(){
    running=false; startPauseBtn.textContent='‚ñ∂ Start';
    sessionSeconds=parseInt(durationEl.value,10)*60; remaining=sessionSeconds; lastTick=null;
    pattern=computePattern(); phaseRemaining=0; setPhase('ready',300);
    statusEl.textContent='Ready'; progressEl.textContent='0%'; timerEl.textContent=fmt(remaining);
  }
  function tick(now){
    if(!running) return;
    if(!lastTick) lastTick=now; const dt=(now-lastTick)/1000; lastTick=now;
    remaining-=dt;
    if(remaining<=0){
      remaining=0; running=false; startPauseBtn.textContent='‚ñ∂ Start'; setPhase('done',400);
      statusEl.textContent='Complete'; progressEl.textContent='100%'; timerEl.textContent=fmt(remaining);
      return;
    }
    timerEl.textContent=fmt(remaining);
    const pct=((sessionSeconds-remaining)/sessionSeconds)*100; progressEl.textContent=`${Math.min(100,Math.floor(pct))}%`;
    if(phaseRemaining<=0){
      const idx=(pattern._idx||0)%pattern.length; const step=pattern[idx]; pattern._idx=idx+1; phaseRemaining=step.secs; setPhase(step.phase, step.secs*1000);
    }
    phaseRemaining-=dt; requestAnimationFrame(tick);
  }

  // ==== AUDIO / VOICES ====
  function ensureAudio(){ if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)(); if(audioCtx.state==='suspended') audioCtx.resume(); }
  function chime(freq=392){
    try{
      ensureAudio();
      const o=audioCtx.createOscillator(), g=audioCtx.createGain();
      o.type='sine'; o.frequency.value=freq; o.connect(g); g.connect(audioCtx.destination);
      const n=audioCtx.currentTime; g.gain.setValueAtTime(0,n);
      g.gain.linearRampToValueAtTime(0.08,n+0.02); g.gain.exponentialRampToValueAtTime(0.0001,n+0.35);
      o.start(n); o.stop(n+0.36);
    }catch(e){}
  }
  const voiceParams=()=>({rate:parseFloat(voiceRate.value),pitch:parseFloat(voicePitch.value),vol:parseFloat(voiceVol.value)});
  const getSelectedVoice=()=>{ if(!voices.length||!selectedVoiceName) return null; return voices.find(v=>v.name===selectedVoiceName)||null; };

  // Browser TTS
  function speakBrowser(text){
    try{
      const msg=new SpeechSynthesisUtterance(text);
      const p=voiceParams(); const v=getSelectedVoice();
      if(v) msg.voice=v; msg.rate=p.rate; msg.pitch=p.pitch; msg.volume=p.vol;
      window.speechSynthesis.speak(msg);
    }catch(e){}
  }

  // ElevenLabs TTS (simple: returns audio/mpeg blob and plays it)
  async function speakElevenLabs(text, which='A'){
    const key = LS.get('EL_API_KEY') || (elApiKey.value||'').trim();
    const voiceId = (which==='A' ? (LS.get('EL_VOICE_A')||elVoiceA.value) : (LS.get('EL_VOICE_B')||elVoiceB.value) || '').trim();
    if(!key || !voiceId){ alert('Please set ElevenLabs API Key and Voice ID.'); return; }
    const body = {
      text,
      model_id: "eleven_monolingual_v1",
      voice_settings: { stability: 0.6, similarity_boost: 0.85 }
    };
    try{
      const res = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${voiceId}`, {
        method: 'POST',
        headers: { 'xi-api-key': key, 'Content-Type':'application/json', 'Accept':'audio/mpeg' },
        body: JSON.stringify(body)
      });
      if(!res.ok){ throw new Error('TTS failed: ' + res.status); }
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      const a = new Audio(url);
      a.volume = voiceParams().vol;
      await a.play().catch(()=>{});
      setTimeout(()=> URL.revokeObjectURL(url), 10000);
    }catch(err){
      console.error(err);
      alert('ElevenLabs error. Check your key/voice ID and network.');
    }
  }

  // Unified speak()
  function speak(text){
    const src = voiceSource.value;
    if(src==='browser'){ speakBrowser(text); }
    else if(src==='elA'){ speakElevenLabs(text,'A'); }
    else if(src==='elB'){ speakElevenLabs(text,'B'); }
  }

  // ==== Workday reminders ====
  const parseTime=t=>{ const [hh,mm]=t.split(':').map(v=>parseInt(v,10)); const d=new Date(); d.setHours(hh,mm||0,0,0); return d; };
  const inWorkWindow=now=>{
    const s=parseTime(workStartEl.value), e=parseTime(workEndEl.value);
    if(e<=s){ const e2=new Date(e.getTime()+86400000); return (now>=s)||(now<e2); }
    return now>=s && now<=e;
  };
  function scheduleNextBreak(base){
    const intervalMin=Math.max(1,parseInt(breakEveryEl.value,10));
    const next=new Date((base||new Date()).getTime()+intervalMin*60000);
    nextBreakAt=next;
    const lead=Math.max(0,parseInt(stretchLeadEl.value,10));
    nextStretchAt=new Date(next.getTime()-lead*60000);
    nextBreakLabel.textContent=next.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
  }
  function announce(text){
    const style=reminderStyleEl.value;
    if(style==='voice'){ speak(text) }
    else if(style==='chime'){ chime(660); setTimeout(()=>chime(523.25),250) }
    else { speak(text); setTimeout(()=>chime(660),200) }
  }
  function schedulerLoop(){
    if(!workActive) return;
    const now=new Date();
    if(!inWorkWindow(now)){ workStatus.textContent='outside work hours'; workStatus.className='warn'; nextBreakLabel.textContent='‚Äî'; return; }
    workStatus.textContent='active'; workStatus.className='ok';
    if(!nextBreakAt) scheduleNextBreak(now);
    if(nextStretchAt && now>=nextStretchAt){ announce('Time to stand and stretch.'); nextStretchAt=null; }
    if(nextBreakAt && now>=nextBreakAt){ announce('It is time to take a break.'); scheduleNextBreak(now); }
  }

  // ==== Browser voice loading ====
  function fillVoiceSelect(){
    voiceSelect.innerHTML='';
    voices.forEach(v=>{
      const o=document.createElement('option');
      o.value=v.name; o.textContent=`${v.name} ‚Äî ${v.lang}`;
      voiceSelect.appendChild(o);
    });
    if(!selectedVoiceName && voices[0]) selectedVoiceName=voices[0].name;
    voiceSelect.value=selectedVoiceName||'';
    voiceStatus.textContent = voices.length ? `Loaded ${voices.length} voices` : 'No voices found';
  }
  async function loadVoices(maxTries=20){
    if(!('speechSynthesis' in window)){ voiceStatus.textContent='Speech not supported'; return; }
    voices = window.speechSynthesis.getVoices();
    if(voices.length){ fillVoiceSelect(); return; }
    for(let i=0;i<maxTries;i++){
      await new Promise(r=>setTimeout(r,200));
      voices = window.speechSynthesis.getVoices();
      if(voices.length){ fillVoiceSelect(); return; }
    }
    try{ window.speechSynthesis.speak(new SpeechSynthesisUtterance(' ')); }catch(e){}
    await new Promise(r=>setTimeout(r,250));
    voices = window.speechSynthesis.getVoices(); fillVoiceSelect();
  }

  // ==== Wire UI ====
  startPauseBtn.addEventListener('click',()=>{ ensureAudio(); if(!running){ if(remaining<=0) resetSession(); running=true; statusEl.textContent='In session'; pattern=computePattern(); requestAnimationFrame(t=>{lastTick=t; tick(t)}); startPauseBtn.textContent='‚è∏ Pause'; } else { running=false; statusEl.textContent='Paused'; startPauseBtn.textContent='‚ñ∂ Resume'; } });
  resetBtn.addEventListener('click', resetSession);
  durationEl.addEventListener('input', ()=>{ durationLabel.textContent=durationEl.value; if(!running){ sessionSeconds=parseInt(durationEl.value,10)*60; remaining=sessionSeconds; timerEl.textContent=fmt(remaining); progressEl.textContent='0%'; }});
  modeEl.addEventListener('change', ()=>{ pattern=computePattern() });
  soundBtn.addEventListener('click', ()=>{ ensureAudio(); soundOn=!soundOn; soundBtn.textContent = soundOn?'üîî Chime: On':'üîî Chime: Off'; if(soundOn) chime(660); });
  mantraBtn.addEventListener('click', ()=>{ mantraOn=!mantraOn; mantraBtn.textContent = mantraOn?'üïâÔ∏è Mantra: On':'üïâÔ∏è Mantra: Off'; mantraEl.style.display = mantraOn?'block':'none'; });
  guidedBtn.addEventListener('click', ()=>{ guidedOn=!guidedOn; guidedBtn.textContent = guidedOn?'üéß Guided Voice: On':'üéß Guided Voice: Off'; if(guidedOn) speak('Guided voice on'); else speak('Guided voice off'); });

  [workStartEl,workEndEl,breakEveryEl,stretchLeadEl,reminderStyleEl].forEach(el=>el.addEventListener('change',()=>{ if(workActive) scheduleNextBreak(new Date()); }));
  startWorkBtn.addEventListener('click', ()=>{ ensureAudio(); workActive=true; scheduleNextBreak(new Date()); workStatus.textContent='active'; workStatus.className='ok'; if(!schedulerTimer) schedulerTimer=setInterval(schedulerLoop, 500); });
  stopWorkBtn.addEventListener('click', ()=>{ workActive=false; workStatus.textContent='stopped'; workStatus.className='warn'; nextBreakAt=null; nextStretchAt=null; nextBreakLabel.textContent='‚Äî'; if(schedulerTimer){ clearInterval(schedulerTimer); schedulerTimer=null; } });
  testReminderBtn.addEventListener('click', ()=>{ ensureAudio(); announce('It is time to take a break.'); });

  // Browser voices
  voiceSelect.addEventListener('change', ()=>{ selectedVoiceName=voiceSelect.value; speakBrowser('Voice selected'); });
  saySample.addEventListener('click', ()=>{ ensureAudio(); speak('This is your guided voice sample.'); });
  reloadVoicesBtn.addEventListener('click', ()=>{ loadVoices(20); voiceStatus.textContent='Reloading voices‚Ä¶'; });
  unlockAudioBtn.addEventListener('click', ()=>{ ensureAudio(); try{ window.speechSynthesis.speak(new SpeechSynthesisUtterance('Audio unlocked')); }catch(e){} });
  useDefaultBtn.addEventListener('click', ()=>{ selectedVoiceName=''; speakBrowser('Using default voice'); });

  // Voice source UI toggles + creds
  function updateVoiceSourceUI(){
    const src = voiceSource.value;
    const showEL = (src==='elA'||src==='elB');
    browserVoiceBlock.style.display = (src==='browser') ? 'block' : 'none';
    elCreds.style.display = showEL ? 'grid' : 'none';
    elVoices.style.display = showEL ? 'grid' : 'none';
  }
  voiceSource.addEventListener('change', updateVoiceSourceUI);
  updateVoiceSourceUI();

  // Load saved creds
  (function restoreSaved(){
    const key = LS.get('EL_API_KEY'); if(key) elApiKey.value = key;
    const vA = LS.get('EL_VOICE_A'); if(vA) elVoiceA.value = vA;
    const vB = LS.get('EL_VOICE_B'); if(vB) elVoiceB.value = vB;
  })();

  saveElCreds.addEventListener('click', ()=>{ if(elApiKey.value) LS.set('EL_API_KEY', elApiKey.value); if(elVoiceA.value) LS.set('EL_VOICE_A', elVoiceA.value); if(elVoiceB.value) LS.set('EL_VOICE_B', elVoiceB.value); alert('Saved locally (this browser only).'); });
  clearElCreds.addEventListener('click', ()=>{ LS.del('EL_API_KEY'); LS.del('EL_VOICE_A'); LS.del('EL_VOICE_B'); elApiKey.value=''; elVoiceA.value=''; elVoiceB.value=''; alert('Cleared.'); });

  testElA.addEventListener('click', ()=> speakElevenLabs('This is ElevenLabs Voice A test. Smooth and calm.', 'A'));
  testElB.addEventListener('click', ()=> speakElevenLabs('This is ElevenLabs Voice B test. Warm and gentle.', 'B'));

  // Init
  resetSession(); loadVoices(20);

  // Versioned Service Worker
  if('serviceWorker' in navigator){
    window.addEventListener('load', ()=>{
      navigator.serviceWorker.register('./service-worker.js?v=3.0.0')
        .then(reg => { if(reg.waiting) reg.waiting.postMessage({type:'SKIP_WAITING'}); })
        .catch(()=>{});
    });
  }
})();
</script>
</body>
</html>

