<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Break & Breathe ‚Äî Timed Meditation Breaks</title>
<meta name="description" content="Timed meditation breaks (10‚Äì30 min) with Yogananda-inspired Hong-Sau breathing, posture checks, chimes, and a calming breath pacer.">
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0b1324">
<style>
  :root{
    --bg: #0b1324;
    --card: #121c34;
    --accent: #8ad1ff;
    --text: #e8f0ff;
    --muted: #a9b8d6;
    --ring: rgba(138,209,255,0.25);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans";
    color:var(--text);
    background:
      radial-gradient(1200px 600px at 80% -10%, #1e2a4d 0%, transparent 60%),
      radial-gradient(900px 400px at -10% 120%, #1b2747 0%, transparent 60%),
      var(--bg);
    display:flex;align-items:center;justify-content:center;
    padding:24px;
  }
  .app{width:min(1000px, 100%);backdrop-filter: blur(8px);}
  .card{background: linear-gradient(180deg, rgba(18,28,52,0.9), rgba(13,20,38,0.92));border:1px solid rgba(255,255,255,0.06);border-radius:16px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.04)}
  header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:12px}
  .title{font-weight:700;font-size:clamp(20px, 4vw, 28px);letter-spacing:0.2px;display:flex;align-items:center;gap:12px}
  .badge{font-size:12px;padding:4px 8px;border-radius:999px;background:rgba(138,209,255,0.12);color:var(--accent);border:1px solid rgba(138,209,255,0.25)}
  .controls{display:grid;grid-template-columns:1fr;gap:14px;margin:10px 0 8px}
  @media (min-width:720px){.controls{grid-template-columns:1.2fr 1fr 1fr 1fr}}
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
  select,input[type="range"],.btn{width:100%;border:1px solid rgba(255,255,255,0.08);background:rgba(255,255,255,0.03);color:var(--text);border-radius:12px;padding:10px 12px;font-size:14px;outline:none}
  select:focus,input[type="range"]:focus,.btn:focus{box-shadow:0 0 0 3px rgba(138,209,255,0.25)}
  .btn{cursor:pointer;text-align:center;user-select:none;transition:transform .05s ease}
  .btn:active{transform:translateY(1px)}
  .btn.primary{background:linear-gradient(180deg, rgba(138,209,255,0.18), rgba(138,209,255,0.08));border-color:rgba(138,209,255,0.35)}
  .btn.ghost{background:rgba(255,255,255,0.03)}
  .row{display:flex;gap:10px}.row>.btn{flex:1}
  .grid{display:grid;gap:16px;grid-template-columns:1fr;align-items:stretch}
  @media (min-width:940px){.grid{grid-template-columns:1.2fr 0.8fr}}
  .pacer-wrap{position:relative;aspect-ratio:1/1;display:flex;align-items:center;justify-content:center;background:radial-gradient(40% 40% at 50% 50%, rgba(138,209,255,0.1), rgba(255,255,255,0.02));border-radius:18px;overflow:hidden;border:1px solid rgba(255,255,255,0.06)}
  .pacer{width:min(360px,70%);aspect-ratio:1/1;border-radius:50%;border:2px solid var(--ring);box-shadow:0 0 60px 10px var(--ring), inset 0 0 50px rgba(138,209,255,0.12);display:flex;align-items:center;justify-content:center;transform:scale(0.88);transition:transform var(--phase-ms, 3000ms) linear}
  .pacer .dot{width:14px;height:14px;border-radius:50%;background:var(--accent);box-shadow:0 0 20px var(--accent),0 0 50px var(--accent);opacity:0.9}
  [data-phase="inhale"] .pacer{transform:scale(1.06)} [data-phase="exhale"] .pacer{transform:scale(0.88)} [data-phase="hold"] .pacer{transform:scale(0.97)}
  .hud{position:absolute;inset:10px 10px auto 10px;display:flex;justify-content:space-between;align-items:center;font-size:12px;color:var(--muted)}
  .timer{position:absolute;inset:auto 0 24px 0;text-align:center;font-size:clamp(22px,5vw,48px);font-weight:700;letter-spacing:1.2px}
  .phase{position:absolute;inset:auto 0 80px 0;text-align:center;font-size:clamp(14px,3vw,18px);color:var(--muted)}
  .mantra{position:absolute;inset:auto 0 120px 0;text-align:center;font-size:clamp(34px,7vw,56px);font-weight:700;letter-spacing:1.5px;opacity:0.18;user-select:none;pointer-events:none}
  .posture{padding:14px;border:1px solid rgba(255,255,255,0.06);border-radius:12px;background:rgba(255,255,255,0.03)}
  .posture h3{margin:0 0 8px 0;font-size:16px}
  .check{display:flex;align-items:flex-start;gap:10px;margin:8px 0;font-size:14px}
  .check input{margin-top:3px}
  .muted{color:var(--muted);font-size:13px}
  .stats{display:flex;gap:16px;flex-wrap:wrap;margin-top:12px;color:var(--muted);font-size:13px}
  footer{margin-top:12px;color:var(--muted);font-size:12px;text-align:center}
  @media (prefers-reduced-motion: reduce){.pacer{transition:none;transform:scale(1)}[data-phase] .pacer{transform:scale(1)}}
</style>
</head>
<body>
  <div class="app">
    <div class="card">
      <header>
        <div class="title">üßò‚Äç‚ôÇÔ∏è Break &amp; Breathe <span class="badge">MVP</span></div>
        <div class="muted">Space = start/pause ¬∑ R = reset</div>
      </header>

      <div class="controls">
        <div>
          <label for="mode">Breathing Mode</label>
          <select id="mode" aria-label="Breathing mode">
            <option value="hongsau">Hong-Sau (gentle, natural)</option>
            <option value="equal">Equal Count (in = out)</option>
            <option value="box">Box 4-4-4-4</option>
            <option value="478">4-7-8</option>
          </select>
        </div>

        <div>
          <label for="duration">Session Length: <span id="durationLabel">20</span> min</label>
          <input type="range" id="duration" min="10" max="30" step="5" value="20" aria-label="Session length in minutes">
        </div>

        <div>
          <label for="sound">Sound &amp; Mantra</label>
          <div class="row">
            <button id="sound" class="btn ghost" aria-pressed="false" aria-label="Toggle chime">üîî Chime: Off</button>
            <button id="mantraBtn" class="btn ghost" aria-pressed="true" aria-label="Toggle mantra text">üïâÔ∏è Mantra: On</button>
          </div>
        </div>

        <div>
          <label>Controls</label>
          <div class="row">
            <button id="startPause" class="btn primary">‚ñ∂ Start</button>
            <button id="reset" class="btn ghost">‚ü≤ Reset</button>
          </div>
        </div>
      </div>

      <div class="grid">
        <div class="pacer-wrap card" id="stage" data-phase="ready" aria-live="polite" aria-atomic="true">
          <div class="hud">
            <div id="status" class="muted">Ready</div>
            <div id="progress" class="muted">0%</div>
          </div>

          <div class="pacer" id="pacer" aria-hidden="true"><div class="dot"></div></div>
          <div class="mantra" id="mantra" aria-hidden="true"></div>
          <div class="phase" id="phase">‚Äî</div>
          <div class="timer" id="timer">20:00</div>
        </div>

        <div class="posture">
          <h3>Posture Check</h3>
          <div class="check"><input type="checkbox" id="p1"><label for="p1">Feet grounded and balanced (or sit bones rooted if on cushion)</label></div>
          <div class="check"><input type="checkbox" id="p2"><label for="p2">Spine tall, natural curves; chin gently tucked (‚Äúlong neck‚Äù)</label></div>
          <div class="check"><input type="checkbox" id="p3"><label for="p3">Shoulders melt down; chest open but soft</label></div>
          <div class="check"><input type="checkbox" id="p4"><label for="p4">Jaw unclenched; tongue relaxed on the roof of mouth</label></div>
          <div class="check"><input type="checkbox" id="p5"><label for="p5">Eyes softly closed or half-closed; gaze turned inward</label></div>
          <div class="check"><input type="checkbox" id="p6"><label for="p6">Hands resting comfortably (palms up or down)</label></div>
          <details style="margin-top:8px">
            <summary class="muted">Why Hong-Sau?</summary>
            <div class="muted" style="margin-top:8px">
              Hong-Sau pairs natural breathing with the mental sounds ‚ÄúHong‚Äù (in-breath) and ‚ÄúSau‚Äù (out-breath).
              Let the breath remain easy‚Äîdon‚Äôt force the counts. If the pacer‚Äôs rhythm doesn‚Äôt suit you, simply observe your breath.
            </div>
          </details>
          <div class="stats" id="stats"></div>
        </div>
      </div>

      <footer>
        This tool is for relaxation and focus only. Not medical advice. If you feel dizzy or uncomfortable, pause and breathe normally.
      </footer>
    </div>
  </div>

<script>
(() => {
  const modeEl = document.getElementById('mode');
  const durationEl = document.getElementById('duration');
  const durationLabel = document.getElementById('durationLabel');
  const startPauseBtn = document.getElementById('startPause');
  const resetBtn = document.getElementById('reset');
  const soundBtn = document.getElementById('sound');
  const mantraBtn = document.getElementById('mantraBtn');

  const stage = document.getElementById('stage');
  const pacer = document.getElementById('pacer');
  const timerEl = document.getElementById('timer');
  const phaseEl = document.getElementById('phase');
  const mantraEl = document.getElementById('mantra');
  const statusEl = document.getElementById('status');
  const progressEl = document.getElementById('progress');
  const statsEl = document.getElementById('stats');

  let running = false;
  let sessionSeconds = parseInt(durationEl.value, 10) * 60;
  let remaining = sessionSeconds;
  let lastTick = null;

  let phase = 'ready';
  let phaseRemaining = 0;
  let pattern = [];

  let soundOn = false;
  let mantraOn = true;

  const store = {
    get k(){ return 'bb_stats_v1' },
    read(){ try{ return JSON.parse(localStorage.getItem(this.k) || '{}') }catch(e){ return {} } },
    write(d){ localStorage.setItem(this.k, JSON.stringify(d)) },
    bump(mins){
      const s = this.read();
      s.sessions = (s.sessions||0) + 1;
      s.totalMin = (s.totalMin||0) + mins;
      s.last = new Date().toISOString();
      this.write(s); renderStats();
    }
  };

  function renderStats(){
    const s = store.read();
    statsEl.innerHTML = `
      <div>Sessions: <span style="color:#5ee4a7">${s.sessions||0}</span></div>
      <div>Total minutes: <span style="color:#5ee4a7">${s.totalMin||0}</span></div>
      ${s.last ? `<div>Last: <span>${new Date(s.last).toLocaleString()}</span></div>` : ''}
    `;
  }
  renderStats();

  function fmt(sec){
    sec = Math.max(0, Math.round(sec));
    const m = Math.floor(sec/60), s = sec%60;
    return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  }

  function setPhase(newPhase, ms){
    phase = newPhase;
    stage.dataset.phase = (newPhase === 'hold' ? 'hold' : newPhase);
    phaseEl.textContent = (newPhase === 'hold') ? 'Hold' : (newPhase.charAt(0).toUpperCase() + newPhase.slice(1));
    pacer.style.setProperty('--phase-ms', (ms||1000)+'ms');

    if(mantraOn){
      if(modeEl.value === 'hongsau'){
        mantraEl.textContent = (newPhase === 'inhale') ? 'HONG' : (newPhase === 'exhale' ? 'SAU' : '');
      }else{
        mantraEl.textContent = (newPhase === 'inhale') ? 'IN' : (newPhase === 'exhale' ? 'OUT' : '');
      }
      mantraEl.style.display = 'block';
    }else{
      mantraEl.style.display = 'none';
    }

    if(soundOn && (newPhase === 'inhale' || newPhase === 'exhale' || newPhase === 'done')){
      chime(newPhase === 'exhale' ? 523.25 : (newPhase === 'done' ? 784 : 392));
    }
  }

  function computePattern(){
    const m = modeEl.value;
    if(m === 'hongsau'){ return [{phase:'inhale', secs:4.5},{phase:'exhale', secs:5.5}] }
    if(m === 'box'){ return [{phase:'inhale', secs:4},{phase:'hold', secs:4},{phase:'exhale', secs:4},{phase:'hold', secs:4}] }
    if(m === '478'){ return [{phase:'inhale', secs:4},{phase:'hold', secs:7},{phase:'exhale', secs:8}] }
    return [{phase:'inhale', secs:4},{phase:'exhale', secs:4}]; // equal
  }

  function updateDurationLabel(){ durationLabel.textContent = durationEl.value }

  function resetSession(){
    running = false;
    startPauseBtn.textContent = '‚ñ∂ Start';
    sessionSeconds = parseInt(durationEl.value, 10) * 60;
    remaining = sessionSeconds;
    lastTick = null;
    pattern = computePattern();
    phaseRemaining = 0;
    setPhase('ready', 300);
    statusEl.textContent = 'Ready';
    progressEl.textContent = '0%';
    timerEl.textContent = fmt(remaining);
  }

  function tick(now){
    if(!running) return;
    if(!lastTick) lastTick = now;
    const dt = (now - lastTick)/1000;
    lastTick = now;

    remaining -= dt;
    if(remaining <= 0){
      remaining = 0;
      running = false;
      startPauseBtn.textContent = '‚ñ∂ Start';
      setPhase('done', 400);
      statusEl.textContent = 'Complete';
      progressEl.textContent = '100%';
      timerEl.textContent = fmt(remaining);
      store.bump(Math.round(sessionSeconds/60));
      return;
    }
    timerEl.textContent = fmt(remaining);
    const pct = ((sessionSeconds - remaining)/sessionSeconds) * 100;
    progressEl.textContent = `${Math.min(100, Math.floor(pct))}%`;

    if(phaseRemaining <= 0){
      const idx = (pattern._idx || 0) % pattern.length;
      const step = pattern[idx];
      pattern._idx = idx + 1;
      phaseRemaining = step.secs;
      setPhase(step.phase, step.secs * 1000);
    }
    phaseRemaining -= dt;
    requestAnimationFrame(tick);
  }

  let audioCtx = null;
  function chime(freq=392){
    try{
      if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type='sine'; o.frequency.value=freq;
      o.connect(g); g.connect(audioCtx.destination);
      const now = audioCtx.currentTime;
      g.gain.setValueAtTime(0, now);
      g.gain.linearRampToValueAtTime(0.08, now + 0.02);
      g.gain.exponentialRampToValueAtTime(0.0001, now + 0.35);
      o.start(now); o.stop(now + 0.36);
    }catch(e){}
  }

  startPauseBtn.addEventListener('click', () => {
    if(!running){
      if(remaining <= 0){ resetSession(); }
      running = true;
      statusEl.textContent = 'In session';
      pattern = computePattern();
      requestAnimationFrame((t) => { lastTick = t; tick(t); });
      startPauseBtn.textContent = '‚è∏ Pause';
    }else{
      running = false;
      statusEl.textContent = 'Paused';
      startPauseBtn.textContent = '‚ñ∂ Resume';
    }
  });

  resetBtn.addEventListener('click', resetSession);
  modeEl.addEventListener('change', () => { pattern = computePattern() });
  durationEl.addEventListener('input', () => {
    updateDurationLabel();
    if(!running){
      sessionSeconds = parseInt(durationEl.value,10)*60;
      remaining = sessionSeconds;
      timerEl.textContent = fmt(remaining);
      progressEl.textContent = '0%';
    }
  });
  soundBtn.addEventListener('click', () => {
    soundOn = !soundOn;
    soundBtn.setAttribute('aria-pressed', String(soundOn));
    soundBtn.textContent = soundOn ? 'üîî Chime: On' : 'üîî Chime: Off';
    if(soundOn){ chime(660) }
  });
  mantraBtn.addEventListener('click', () => {
    mantraOn = !mantraOn;
    mantraBtn.setAttribute('aria-pressed', String(mantraOn));
    mantraBtn.textContent = mantraOn ? 'üïâÔ∏è Mantra: On' : 'üïâÔ∏è Mantra: Off';
    mantraEl.style.display = mantraOn ? 'block' : 'none';
  });

  window.addEventListener('keydown', (e) => {
    if(e.code === 'Space'){ e.preventDefault(); startPauseBtn.click(); }
    if(e.key.toLowerCase() === 'r'){ e.preventDefault(); resetBtn.click(); }
  });

  for(let i=1;i<=6;i++){
    const el = document.getElementById('p'+i);
    const key = 'bb_posture_'+i;
    el.checked = localStorage.getItem(key) === '1';
    el.addEventListener('change', () => {
      localStorage.setItem(key, el.checked ? '1' : '0');
    });
  }

  updateDurationLabel();
  resetSession();

  if('serviceWorker' in navigator){
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./service-worker.js').catch(()=>{});
    });
  }
  setTimeout(() => { statusEl.textContent = 'Ready ‚Äî choose a mode and press Start' }, 800);
})();
</script>
</body>
</html>
